# Drupal (and Boost) Friendly configuration to use Nginx as a reverse-proxy. Generated by Chef
server {
  listen <%= node['deploy-drupal']['nginx_port'] %> default;
  root <%= @site_path %>;
  
  set $boost_query "_";

  gzip  on;
  gzip_static on;

  gzip_types
    text/plain
    text/css
    application/json
    application/x-javascript
    text/xml
    application/xml
    application/xml+rss
    text/javascript;

  ##### DENY ACCESS:
  location ~ ^\. {
    deny all;
  }
  location ~ \.(engine|inc|info|install|module|profile|po|sh|.*sql|theme|tpl(\.php)?|xtmpl)$ {
    deny all;
  }
  location ~ ^(code-style\.pl|Entries.*|Repository|Root|Tag|Template)$ { 
    deny all;
  }
  location ~ boost-crawler {
    deny all;
  }
  
  ##### STATIC CONTENT
  location ~* \.(jpg|jpeg|gif|png|bmp|ico|pdf|ps|djvu|doc|docx|rtf|xls|htm)(\.gz)?$ {
    expires max;
    try_files $request_uri @drupal;
    break;
  }
  location ~* \.(flv|mp3|wmv|wma|wav|ogg|mpg|mpeg|mpg4|mp4|avi)(\.gz)?$ {
    expires max;
    try_files $request_uri @drupal;
    break;
  }
  location ~* \.(zip|bz2|tar|tgz|rar)(\.gz)?$ {
    expires max;
    try_files $request_uri @drupal;
    break;
  }
  # for css,js files try Boost cache too
  location ~* \.(css|js)(\.gz)?$ {
    expires max;
    try_files $request_uri /cache/perm/$http_host$request_uri$boost_query.$1 @drupal;
    break;
  }
  # add_header for html and xml files
  location ~* \.(html|xml)$ {
    add_header Cache-Control no-cache,no-store,must-validate;
    try_files $request_uri @drupal;
    break;
  }
  
  #### NOT FOUND 404
  # Fallback on Drupal for 404
  error_page 404 = @drupal;
  # Do not serve cached pages if they are not GET requests
  if ( $request_method != GET ) {
    return 404;
  }
  # Do not serve cached pages if user is logged in
  if ($http_cookie ~ "DRUPAL_UID") {
    return 404;
  }
  # Serve the boost html page if it exists or goto drupal. Note: unlike js/css,
  # we do not want to cache in browser.
  location / {
    add_header Cache-Control no-cache,no-store,must-validate;
    try_files /cache/normal/$http_host$request_uri$boost_query$query_string.html @drupal;
  }
  
  ##### LOGS
  access_log  <%= node['nginx']['log_dir'] %>/access.log;
  error_log   <%= node['nginx']['log_dir'] %>/error.log;
  
  # Define the log format for proxy activity
  log_format  drupal_proxy  '$remote_addr - $remote_user [$time_local] "$request" $status $body_bytes_sent "$http_referer" "$http_user_agent" "$http_x_forwarded_for" "$http_host" "$proxy_add_x_forwarded_for"';

  # proxy ip's
  proxy_set_header X-Real-IP  $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header Host $http_host;

  # Define named location @drupal, proxy to Apache
  location @drupal{
    access_log  <%= node['nginx']['log_dir'] %>/proxy.access.log drupal_proxy;
    proxy_pass http://127.0.0.1:<%= node['deploy-drupal']['apache_port']%>;
  }
}
